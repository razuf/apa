defmodule ApaTest do
  @moduledoc """
  Documentation for `ApaTest`.
  """
  use ExUnit.Case
  import Apa
  import Kernel, except: [+: 2, -: 2, *: 2, /: 2, to_string: 1]

  doctest Apa
  doctest ApaNumber

  test "wrong input - no strings" do
    assert_raise ArgumentError, fn -> Apa.add(1, 2) end
    assert_raise ArgumentError, fn -> Apa.sub(1, 2) end
    assert_raise ArgumentError, fn -> Apa.mul(1, 2) end
    assert_raise ArgumentError, fn -> Apa.div(1, 2) end
  end

  test "wrong division with 0" do
    assert_raise ArgumentError, fn -> Apa.div("1", "0") end
  end

  test "add test" do
    assert Apa.add("1", "2") == "3"
  end

  test "sub test" do
    assert Apa.sub("3", "2") == "1"
  end

  test "mul test" do
    assert Apa.mul("3", "2") == "6"
  end

  test "div test" do
    assert Apa.div("6", "2") == "3"
  end

  test "Apa.add - some random numbers - also with leading and trailing zeros" do
    for _n <- 1..2 do
      left =
        Enum.take(
          StreamData.integer(0..9),
          300
        )
        |> Enum.join("")

      right =
        Enum.take(
          StreamData.integer(0..9),
          300
        )
        |> Enum.join()

      Apa.add(left, right)
      assert true == true
    end
  end

  test "elixir_add - some random numbers - also with leading and trailing zeros" do
    for _n <- 1..2 do
      left =
        Enum.take(
          StreamData.integer(0..9),
          300
        )
        |> Enum.join("")

      right =
        Enum.take(
          StreamData.integer(0..9),
          300
        )
        |> Enum.join()

      elixir_int_add(left, right)
    end

    assert true == true
  end

  test "Apa.add - apa_float test - a little bench" do
    # test with int and for n <- 1..1_000_000 do : 12 s
    # test with float and for n <- 1..1_000_000 do : 103 s - this is a little bit slow - I need to check why
    # test php with int bcmath : 2 s
    # test php with float bcmath : 2 s
    # <?php
    # $start = time();
    # for ($i = 1; $i <= 1000000; $i++) {
    #   $a = "8.09707454052413919635577888440715258946580668428775950474824953017506360127420091940038046771237888664887342053220951123102876333457480052728109806574848871628692024581572876970116185613895631093241810791852687225130663407994467397555082232868305473303185501486875439373305931251988752888510867191442".$i;
    #   $b = $i."1.25737664273696274550555428050391992223318427580244856987886515040304820544244089003522386442562821180853835547526988580462516459446335918383321800211590949268950790878470723946424249952005158462419536507105822922117803735975930795427833559882975690208258765127313622053819431639645657225314642357472";
    #   $res = bcadd($a, $b);
    # }
    # $end= time();
    # echo "\n".($end-$start)." s\n";
    # echo $res."\n";
    # ?>

    for n <- 1..1 do
      left =
        "8.09707454052413919635577888440715258946580668428775950474824953017506360127420091940038046771237888664887342053220951123102876333457480052728109806574848871628692024581572876970116185613895631093241810791852687225130663407994467397555082232868305473303185501486875439373305931251988752888510867191442#{
          n
        }"

      right =
        "#{n}1.25737664273696274550555428050391992223318427580244856987886515040304820544244089003522386442562821180853835547526988580462516459446335918383321800211590949268950790878470723946424249952005158462419536507105822922117803735975930795427833559882975690208258765127313622053819431639645657225314642357472"

      assert Apa.add(left, right) ==
               "19.354451183261101941861333164911072511698990960090208074627114680578111806716641809435604332138007098457411776007479397035653927929038159711114316067864398208976428154600436009165404355659007895556613472989585101472484671439703981929829157927512811635114442666141890614271253628916344101138255095489141"
    end

    assert "19.354451183261101941861333164911072511698990960090208074627114680578111806716641809435604332138007098457411776007479397035653927929038159711114316067864398208976428154600436009165404355659007895556613472989585101472484671439703981929829157927512811635114442666141890614271253628916344101138255095489141" ==
             "19.354451183261101941861333164911072511698990960090208074627114680578111806716641809435604332138007098457411776007479397035653927929038159711114316067864398208976428154600436009165404355659007895556613472989585101472484671439703981929829157927512811635114442666141890614271253628916344101138255095489141"
  end

  test "elixir_add - int test - a little bench" do
    # test with int and for n <- 1..1_000_000 do : 12 s
    # test php with int bcmath                   : 2 s
    # <?php
    # $start = time();
    # for ($i = 1; $i <= 1000000; $i++) {
    #   $a = "809707454052413919635577888440715258946580668428775950474824953017506360127420091940038046771237888664887342053220951123102876333457480052728109806574848871628692024581572876970116185613895631093241810791852687225130663407994467397555082232868305473303185501486875439373305931251988752888510867191442".$i;
    #   $b = $i."125737664273696274550555428050391992223318427580244856987886515040304820544244089003522386442562821180853835547526988580462516459446335918383321800211590949268950790878470723946424249952005158462419536507105822922117803735975930795427833559882975690208258765127313622053819431639645657225314642357472";
    #   $res = bcadd($a, $b);
    # }
    # $end= time();
    # echo "\n".($end-$start)." s\n";
    # echo $res."\n";
    # ?>

    for n <- 1..1 do
      left =
        "809707454052413919635577888440715258946580668428775950474824953017506360127420091940038046771237888664887342053220951123102876333457480052728109806574848871628692024581572876970116185613895631093241810791852687225130663407994467397555082232868305473303185501486875439373305931251988752888510867191442#{
          n
        }"

      right =
        "#{n}125737664273696274550555428050391992223318427580244856987886515040304820544244089003522386442562821180853835547526988580462516459446335918383321800211590949268950790878470723946424249952005158462419536507105822922117803735975930795427833559882975690208258765127313622053819431639645657225314642357472"

      elixir_int_add(left, right)
    end

    assert true == true
  end

  test "elixir_add - float test - a little bench" do
    # test with float and n <- 1..1_000_000  : 13 s
    # test php with float bcmath             : 2 s
    # <?php
    # $start = time();
    # for ($i = 1; $i <= 1000000; $i++) {
    #   $a = "8.09707454052413919635577888440715258946580668428775950474824953017506360127420091940038046771237888664887342053220951123102876333457480052728109806574848871628692024581572876970116185613895631093241810791852687225130663407994467397555082232868305473303185501486875439373305931251988752888510867191442".$i;
    #   $b = $i."1.25737664273696274550555428050391992223318427580244856987886515040304820544244089003522386442562821180853835547526988580462516459446335918383321800211590949268950790878470723946424249952005158462419536507105822922117803735975930795427833559882975690208258765127313622053819431639645657225314642357472";
    #   $res = bcadd($a, $b);
    # }
    # $end= time();
    # echo "\n".($end-$start)." s\n";
    # echo $res."\n";
    # ?>

    for n <- 1..1 do
      left =
        "8.09707454052413919635577888440715258946580668428775950474824953017506360127420091940038046771237888664887342053220951123102876333457480052728109806574848871628692024581572876970116185613895631093241810791852687225130663407994467397555082232868305473303185501486875439373305931251988752888510867191442#{
          n
        }"

      right =
        "#{n}1.25737664273696274550555428050391992223318427580244856987886515040304820544244089003522386442562821180853835547526988580462516459446335918383321800211590949268950790878470723946424249952005158462419536507105822922117803735975930795427833559882975690208258765127313622053819431639645657225314642357472"

      elixir_float_add(left, right)
    end

    assert true == true
  end

  test "some special apa tests" do
    assert "46.83" == Apa.add("1.23", "45.6")
    assert "45600000012.4" == Apa.add("12.3", "45600000000.1")
    assert "0.123456000000001" == Apa.add("0.123", "0.000456000000001")
    assert "0.123456000000001" == Apa.add("0.000456000000001", "0.123")
    assert "579" == "123" + "456"
    assert "123000000000000000000456" == "123000000000000000000000" + "456"
    assert "4560000000000000000123" == "123" + "4560000000000000000000"
    assert "0.00000000000000001" == "3.30000000000000004" - "3.30000000000000003"
    assert "6.71111111111111107" == "3.31111111111111114" + "3.39999999999999993"
    assert "579" == Kernel.to_string(123 + 456)
    assert "690" == Kernel.to_string(123 + 456) + "111"
    assert "12300" == ApaNumber.to_string({123, 2})
    assert "456000" == ApaNumber.to_string({456, 3})
    assert "45600" == ApaNumber.to_string({456, 2})
    assert "57900" == {123, 2} + {456, 2}
    assert "456001.23" == "1.23" + "456e3"
    assert "456001.23" == "1.23" + "456.0e+003"

    assert "132342342342300000000455987.88" ==
             "132342342342300000000000000" + "456e3" - "0012.1200"

    assert "48.884" == "2.2" * "22.22"
    assert "4444444444.4444444444444" == "0.00000000002" * "222222222222222222222.22"
    assert "-48.884" == "0002.20000000" * "-00022.22000000"
    assert "222.2001" == "0.1" * "2222.001"

    assert "10" == "2222.001" / "222.2001"
    assert "4.803996494145874505235775423" == "17.123" / "3.564324"

    price = "3.51 Euro"
    quantity = "12"
    total_string = price * quantity
    assert total_string == "42.12"
  end

  ###################################################################

  defp elixir_int_add(left, right) do
    Kernel.to_string(String.to_integer(left) + String.to_integer(right))
  end

  # only for performance testing - the result for such a big number in normal elixir is wrong!!!
  defp elixir_float_add(left, right) do
    Kernel.to_string(String.to_float(left) + String.to_float(right))
  end
end
